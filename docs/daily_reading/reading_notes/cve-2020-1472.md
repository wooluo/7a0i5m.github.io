# CVE-2020-1472 通过颠覆 Netlogon 加密立即成为域管理员

## POC

\(2020.09.16\):

{% embed url="https://github.com/dirkjanm/CVE-2020-1472" %}



CVE-2020-1472 POC 需要来自 GitHub 的最新impacket，并添加了 netlogon 结构。

请注意，默认情况下，这将更改域控制器帐户的密码。是的， 这允许您 DcSync， 但它也打破了与其他域控制器的通信， 所以要小心这一点！

更多信息和原创研究在这里

利用步骤 阅读上面的博客/白皮书，以便您知道您在做什么 使用 DC 的 IP 和 netbios 名称运行cve-2020-1472-exploit.py DCSync 与机密转储，使用和或空哈希和帐户-just-dc-no-passDCHOSTNAME$ 还原步骤 如果您从 GitHub 安装在 2020 年 9 月 15 日或之后更新的 impacket 版本，则在转储本地注册表机密时，秘密转储将自动转储纯文本计算机密码（十六进制编码）。

或者，在稍旧的版本中，您可以转储相同的密码，首先提取注册表配置单元，然后脱机运行机密转储（然后它将始终打印纯文本键，因为它无法计算 Kerberos 哈希）。

使用此密码，您可以使用 参数运行。这将首先使用空密码对同一 DC 进行身份验证，然后将密码设置回原始 DC。请确保再次提供 netbios 名称和 IP 作为目标，例如：`restorepassword.py-hexpass`

```bash
python restorepassword.py testsegment/s2016dc@s2016dc -target-ip 192.168.222.113 -hexpass e6ad4c4f64e7
```

## Exploit

.NET exploit \(2020.09.16\):

{% embed url="https://github.com/nccgroup/nccfsas/tree/main/Tools/SharpZeroLogon" %}



### SharpZeroLogon

这是 CVE-2020-1472 的漏洞，即零登录。此工具利用 Netlogon 中的加密漏洞实现身份验证绕过。最终，这允许攻击者重置目标域控制器的机器帐户，从而导致域管理员泄露。

此漏洞由 Secura BV 的 Tom Tervoort 发现，2020 年 8 月 11 日由 Microsoft 解决。您可以在他们出色的白皮书中阅读更多关于漏洞的。

虽然存在其他漏洞，但此工具旨在使用CS的功能。因此，它使用 中的函数在 C\# 中写入。这里好一点是，由于结构在默认情况下为零，我们不需要弄乱任何数据包，并且可以干净地使用 Microsoft 提供的 API（相对;\)）。`execute-assemblynetapi32.dll`

### 运行

#### 检查服务器是否易受攻击

若要运行漏洞利用，请从加入的域计算机运行二进制文件，提供域控制器的 FQDN。SharpZeroLogon.exe

仅使用一个参数运行它将测试目标域控制器是否易受 CVE-2020-1472 的影响。

在下面的示例中，域控制器的 FQDN 为：`win-dc01.vulncorp.local`

`execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local` 如果域控制器易受攻击，您将收到一条消息，指示它成功，否则服务器可能已被修补且不易受攻击。

#### 重置计算机帐户密码

首先，需要注意的是，以这种方式重置域控制器计算机帐户密码可能会破坏功能。在系统所有者未了解可能有影响的情况下，不应在生产系统上这样做。当然，一旦重置密码，您就可以执行 dcsync（与计算机帐户一起使用），然后使用域管理员帐户通过官方方法重置密码。但是，在盲目运行实验室环境之前，了解其潜在影响非常重要。

### pth

要重置计算机帐户，请运行以下命令（指定 DC FQDN）：

`execute-assembly SharpZeroLogon.exe win-dc01.vulncorp.local true` 重置计算机帐户密码后，您可以使用 模拟计算机帐户并执行 DCSync。pth

## 介绍

### secura:

{% embed url="https://www.secura.com/blog/zero-logon" %}



上个月，Microsoft 修补了一个非常有趣的漏洞，该漏洞允许在内部网络上站稳脚跟的攻击者只需单击一下即可基本上成为域管理员。从攻击者的角度来看，与域控制器的连接是可能的。

Secura的安全专家TomTervoort去年发现了一个不太严重的Netlogon漏洞，它允许将工作站接管，但攻击者需要一个中间人（PitM）的位置才能工作。现在，他发现协议中的第二个更严重的（CVSS分数：10.0）漏洞。通过为特定的 Netlogon 功能伪造身份验证令牌，他能够调用一个函数，将域控制器的计算机密码设置为已知值。之后，攻击者可以使用此新密码控制域控制器并窃取域管理员的凭据。

此漏洞源于 Netlogon 远程协议使用的加密身份验证方案中的缺陷，除其他事项外，该漏洞可用于更新计算机密码。此缺陷允许攻击者模拟任何计算机（包括域控制器本身）并代表他们执行远程过程调用。

Secura 敦促每个人尽快在所有的域控制器上安装修补程序。请参阅微软的咨询。我们在 Github 上发布了一个测试工具，您可以在此处下载[https://github.com/SecuraBV/CVE-2020-1472，可以告诉您域控制器是否易受攻击。](https://github.com/SecuraBV/CVE-2020-1472，可以告诉您域控制器是否易受攻击。)

如果你对这个非常独特的漏洞背后的技术细节感兴趣，以及它是如何被发现的，请在这里下载白皮书。

有关 CVE 的信息，请与 Secura 联系info@secura.com 。

### rapid7:

{% embed url="https://blog.rapid7.com/2020/09/14/cve-2020-1472-zerologon-critical-privilege-escalation/" %}



今天早些时候，安全公司Secura发表了一篇有关CVE-2020-1472的技术论文，这是微软Netlogon身份验证过程中的一个CVS-10特权升级漏洞，该论文的作者将之命名为"Zerologon"。此漏洞在 Microsoft 2020 年 8 月补丁周二版本中部分修补，它源于 Netlogon 协议的加密实现中的缺陷，特别是使用 AES-CFB8 加密。成功利用的影响是巨大的：该缺陷允许通过牺牲作为域控制器运行的 Windows 服务器来完全接管 Active Directory 域 — 用 Secura 的话说，使"在内部网络上站稳脚跟的攻击者只需单击一下即可基本上成为域管理员。从攻击者的角度来看，与域控制器的连接是有可能的。此 RPC 连接可以通过命名管道直接或通过 SMB 进行。

Secura 的博客包括执行身份验证绕过的概念验证 （PoC）代码，并且很容易被武器化，用于攻击者操作，包括勒索软件和其他恶意软件传播。完全武器化的利用（或几个）不太可能需要很长时间才能打到互联网上。

InsightVM客户可以通过经过身份验证的检查来评估他们接触 CVE-2020-1472的风险敞口。尚未应用 Microsoft 2020 年 8 月 11 日安全更新的组织应考虑在紧急情况下修补 CVE-2020-1472。已成功应用 2020 年 8 月安全更新的 Microsoft 客户可以立即或在 2021 年第 1 季度更新之后部署域控制器 （DC） 实施模式，其中包括此漏洞修补程序的第二部分。Microsoft在此提供了有关如何管理与此漏洞关联的 Netlogon 安全通道连接中的更改的指导。

有关更多快速分析，请进一步评估 Secura 的技术论文和指导，请参阅 Zerologon 的AttackerKB 条目。

### 受影响的产品

基于 x64 的系统服务包 1 的 Windows 服务器 2008 R2 基于 x64 的系统服务包 1 的 Windows 服务器 2008 R2（服务器核心安装） Windows 服务器 2012 Windows 服务器 2012 （服务器核心安装） 视窗服务器 2012 R2 Windows 服务器 2012 R2（服务器核心安装） Windows 服务器 2016 Windows 服务器 2016 （服务器核心安装） Windows 服务器 2019 Windows 服务器 2019 （服务器核心安装） Windows 服务器，版本 1903（服务器核心安装） Windows 服务器，版本 1909（服务器核心安装） Windows 服务器，版本 2004（服务器核心安装）

## 更多

引用

[https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472](https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2020-1472) [https://www.secura.com/blog/zero-logon](https://www.secura.com/blog/zero-logon) [https://github.com/dirkjanm/CVE-2020-1472](https://github.com/dirkjanm/CVE-2020-1472) [https://twitter.com/gentilkiwi/status/1305659499991183361](https://twitter.com/gentilkiwi/status/1305659499991183361)

[https://attackerkb.com/topics/7FbcgDOidQ/cve-2020-1472?referrer=blog\#rapid7-analysis](https://attackerkb.com/topics/7FbcgDOidQ/cve-2020-1472?referrer=blog#rapid7-analysis) [https://www.secura.com/pathtoimg.php?id=2055](https://www.secura.com/pathtoimg.php?id=2055) [https://www.zdnet.com/article/zerologon-attack-lets-hackers-take-over-enterprise-networks/](https://www.zdnet.com/article/zerologon-attack-lets-hackers-take-over-enterprise-networks/) [https://github.com/SecuraBV/CVE-2020-1472](https://github.com/SecuraBV/CVE-2020-1472)

